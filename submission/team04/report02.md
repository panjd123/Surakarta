# 第二阶段报告

> 撰写人：常皓飞  
>
>  ——programming-team-X-C-X

## 已实现的功能

我们不局限于完成当前阶段的任务，而是尽可能增加项目的**游戏性、趣味性**。所以我们在完成了基本要求之后花费了数周时间进行优化，添加细节、功能拓展，让玩家玩起来的时候更加“舒服”。

本阶段**完整记录了更新日志**，可以在仓库中查阅。

### 基本功能

1. 图形化界面
2. 实时显示对局信息
3. 实现本地轮流移子
4. 超时判输
5. 主动认输
6. 判断获胜
7. 能够再来一局

### 拓展（附加）功能

1. **多游戏模式**，接入本地AI，实现与电脑对战，增加游戏性
2. 实现**棋子动画**，包括直线移动与旋吃
3. 实现**行棋提示**
4. **拓展棋盘**至任意偶数多路
5. 添加**设置**选项，可以调整回合限时、玩家执子、棋盘拓展、动画时长
6. 提供较为**流畅的游戏游玩逻辑**，如返回主界面
7. 实现许许多多**细节优化**

## 类的关系与代码框架

在最终版本的本地游戏中，我们的主要界面有以下几个。

#### StartDialog

> 继承自QDialog

这是开始菜单，更是整个游戏逻辑的中转枢纽。这里提供了进入不同模式的入口，以及进入设置选项的入口。

#### GameMainWindow

> 继承自QMainWindow

这是游戏的核心显示界面，提供了开始游戏、返回主菜单、关闭游戏等选项。这里链接其他几个界面。

#### ChessBoardWidget

>继承自QWidget

这是显示棋盘与棋子的地方，当`开始游戏`后就会在GameMainWindow上创建一个ChessBoardWidget对象。主要用于显示棋盘，将当前对局及时更新显示在屏幕上，并且根据每一步的移动信息显示动画。

这些有关对局的核心功能都由该部分实现。

#### EndDialog

> 继承自QDialog

在游戏结束后弹出，用于显示游戏信息，并提供一些操作选项，如回到主菜单、再来一局等。

#### SettingsDialog

> 继承自QDialog
>
> 本窗口唯一使用`Qt Designer`设计出来的界面，自认为也是最丑陋的一个

设置窗口，单纯用于进行设置，调节参数。

## 重点功能介绍

下面我将重点阐述几项重点功能的实现。

### 实现点击棋盘移子

该功能需要重载`ChessBoardWidget::mousePressEvent`，当鼠标点击棋盘，先判断是第一次点击还是第二次点击，然后进行坐标换算，找到点击位置，成为一组move后，向GameMainWindow发信号移动更新信息。

### 实现移动动画

概括地讲，关键在于记录路径，根据路径特征进行数学计算，包括角度、长度等，从而一步步确定棋子移动的动画路线。

### 实现模式切换

不同的按钮对应不同的信号，该信号被传递给GameMainWindow，根据信号做出不同反应，初始化SurakartaGame当中的white_player_ 和black_player_（这里是对SurakartaGame进行了部分重构，使其正确寻找应该从玩家点击还是AI获取当前行棋方式）。如果不匹配，就是非法移动。

### 细节优化

我们比较注重提升当前项目的游戏性，使其不仅仅是一个简单的作业，看起来更像是一个游戏。

#### 显示玩家信息

对局开始前显示双方玩家，对局更新对局信息。

#### 自由选择执子方

在设置中允许玩家自由选择黑棋或白棋与AI对战。

#### 倒计时提示

倒计时长度可以调节，并且剩余10秒变红警示。

#### 返回主界面

对局开始前和结束后可以返回开始界面。

#### 动画优化

1. 实现了直线和曲线移动相结合
2. 保证在动画结束之后再进行下一回合
3. 动画速度可以调节

#### 架构优化

清理掉所有重复代码，将几个模式合并到一组代码下，通过信号进行区分，发生不同的行为。

## 遇到的问题与解决

遇到的最大的问题，莫过于**棋子移动**的实现上。虽然该功能属于可选任务。

我们的确走了很多弯路。最初我们采用QPainter绘画棋子和棋盘，但这样无法移动棋子。因此，要想达成目标，就必须先对已有代码进行重构。（此处略去一万字）

最终，经过一个星期的反复调试，终于让核心游戏逻辑实现了脱胎换骨的变化。在这段时间里，我曾经无比怀疑自己的能力。

突破了最难的一关，后面的实现就顺水推舟了。

## 小组分工

在本阶段中，我们采用了**多线并行**的策略，即各自根据自己的思路先独立进行开发。这主要考虑到，大家对于Qt框架熟悉程度相差较大，**起步阶段直接由多人维护同一个项目并不现实**，大家思路也各不相同。

这种做法的前提是大家开工较早，有充足的时间试验。最终，经过几个星期的磨合，我们评估各自的实现程度和遇到的困难，最终决定采取现在看到的的这套方案。该方案核心代码由常皓飞完成，肖俊皓、向禹共同提出建议、参与优化。

在开发过程中，我们多次线上线下小组讨论，交流当前进度，共享实现思路，互相帮助，互相鼓励。同时，大家积极提出存在的问题与解决建议。

**本阶段的完成离不开小组中每一个人的努力。**

## 当前其他进度

1. stage3开发
2. AI优化

本阶段任务在数周前已经较为成熟（可以参考github小组仓库的chf分支，**commit记录和README.md**里面完整而忠实地记录了项目每一次更新日志）。在此之后，我们已经全部转向联机网络的学习，同时将AI算法的升级提上日程。

> 这也是我们为什么在本阶段依旧选择开发本地游戏，而非直接实现联机的原因。因为**该建议公布的时候，我们的本地游戏实现已经较为成熟了**。当然，我们现在第三阶段也取得了可观的结果。

当前，我们已经实现了三阶段的大半任务，**联网逻辑部分**已经基本完成。~~很遗憾这次没有机会展示（其实是因为如果这样的话，该版本就要基本废弃了，许多内容和功能也许就没有机会亮相了）~~